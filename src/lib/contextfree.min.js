function min(c){var b={value:c[0],index:0};for(var a in c){if(c[a]<b.value){b.value=c[a];b.index=a}}return b}Object.forceExtend=function(d,c){for(var a in c){try{d[a]=c[a]}catch(b){}}return d};if(!Object.extend){Object.extend=Object.forceExtend}function getKeyValue(a,b,d){if(typeof(a)=="string"){a=[a]}for(var e=0;e<=a.length-1;e++){var c=a[e];if(typeof(d[c])!="undefined"){return d[c]}}return b}if(!Array.indexOf){Array.prototype.indexOf=function(b){for(var a=0;a<this.length;a++){if(this[a]==b){return a}}return -1}}function hsl2rgb(j,f,e,d){if(j==360){j=0}while(j<0){j+=360}while(j>360){j-=360}var m,k,c;if(j<120){m=(120-j)/60;k=j/60;c=0}else{if(j<240){m=0;k=(240-j)/60;c=(j-120)/60}else{m=(j-240)/60;k=0;c=(360-j)/60}}m=Math.min(m,1);k=Math.min(k,1);c=Math.min(c,1);m=2*f*m+(1-f);k=2*f*k+(1-f);c=2*f*c+(1-f);if(e<0.5){m=e*m;k=e*k;c=e*c}else{m=(1-e)*m+2*e-1;k=(1-e)*k+2*e-1;c=(1-e)*c+2*e-1}m=Math.ceil(m*255);k=Math.ceil(k*255);c=Math.ceil(c*255);return"rgba("+m+", "+k+", "+c+", "+d+")"}function Tokenizer(){this._input=null;this._gStopChars=[" ","{","}","\n","\r","\t"];this._tokenizeNext=function(d){var e=[];var f=this;for(var c=0;c<this._gStopChars.length;c++){var g=this._gStopChars[c];var h=f._input.indexOf(g,d);if(h!=-1){e.push(h+1)}}var a=min(e);var g=this._gStopChars[a.index];var j=a.value;if(typeof(a.value)=="undefined"){return null}var b=this._input.substr(d,j-d);b=b.replace(/[ \n\r\t]/,"");return{token:b,lastPos:j}};this._tokenize=function(){this._input=this._input.replace(/([{}])/g," $1");var b=[];var a={lastPos:0};while(1==1){a=this._tokenizeNext(a.lastPos);if(a==null){break}if(a.token){b.push(a.token)}}return b};this._load=function(a){var b=document.getElementById(a);this._input=b.value};this.tokenize=function(a){this._load(a);return this._tokenize()}}function Compiler(){this._keywords=["startshape","rule","background"];this._compiled={};this._state=null;var a=this;this._generalState=function(){this.eat=function(b){if(a._keywords.indexOf(b)!=-1){a._state=new a["_"+b+"State"]()}else{console.log(b," is not a general state token!")}}};this._startshapeState=function(){this.eat=function(b){a._compiled.startshape=b;a._state=new a._generalState()}};this._backgroundState=function(){this._realState=new a._abstractArgumentState();this._realState.onDone=function(b){a._compiled.background=b;a._state=new a._generalState()};Object.extend(this,this._realState)};this._abstractArgumentState=function(){this._curKey=null;this._curValues=[];this._obj={};this._flushKey=function(){if(this._curKey){if(this._curValues.length==1){this._obj[this._curKey]=this._curValues[0]}else{this._obj[this._curKey]=this._curValues}}};this.eat=function(b){switch(b){case"}":this._flushKey();this.onDone(this._obj);case"{":return}if(b.match(/[a-z_]+/i)){this._flushKey();this._curKey=b;this._curValues=[]}else{this._curValue=this._curValues.push(parseFloat(b))}};this.onDone=function(b){}};this._ruleState=function(){this.eat=function(b){var c=b;if(!a._compiled[c]){a._compiled[c]=[]}a._state=new a._ruleWeightState(c)}};this._ruleWeightState=function(b){this._weight=1;this.eat=function(c){if(c!="{"){this._weight=parseFloat(c)}else{a._compiled[b].push({weight:this._weight,draw:[]});a._state=new a._ruleDrawState(b)}}};this._ruleDrawState=function(b){this.eat=function(d){if(d=="}"){a._state=new a._generalState();return}var c=d;a._state=new (function(){this._state=new a._abstractArgumentState();this._state.onDone=function(h){var e={shape:c};for(var f in h){e[f]=h[f]}var g=a._compiled[b].length-1;a._compiled[b][g].draw.push(e);a._state=new a._ruleDrawState(b)};Object.extend(this,this._state)})()}};this.compile=function(b){a._state=new a._generalState();b.reverse();while(b.length>0){this._state.eat(b.pop())}return a._compiled}}function colorToRgba(a){return hsl2rgb(a.h,a.s,a.b,a.a)}function adjustColor(b,e){var c={h:b.h,s:b.s,b:b.b,a:b.a};c.h+=getKeyValue(["h","hue"],0,e);c.h%=360;var a={};a.s=getKeyValue(["sat","saturation"],0,e);a.b=getKeyValue(["b","brightness"],0,e);a.a=getKeyValue(["a","alpha"],0,e);for(var d in a){if(a[d]>0){c[d]+=a[d]*(1-b[d])}else{c[d]+=a[d]*b[d]}}return c}function IdentityTransformation(){return[[1,0,0],[0,1,0],[0,0,1]]}function toAffineTransformation(g,f,k,h,e,j){return[[g,f,e],[k,h,j],[0,0,1]]}function compose(d,c){var b=IdentityTransformation();for(var a=0;a<3;a++){for(var g=0;g<3;g++){var e=0;for(var f=0;f<3;f++){e+=d[a][f]*c[f][g]}b[a][g]=e}}return b}Renderer={canvas:null,ctx:null,width:null,height:null,compiled:null,_maxThreads:30,queue:[],render:function(a,b){Renderer.compiled=a;Renderer.canvas=document.getElementById(b);Renderer.ctx=Renderer.canvas.getContext("2d");Renderer.width=Renderer.canvas.width;Renderer.height=Renderer.canvas.height;Renderer._globalScale=300;Renderer._rendering=false;Renderer.drawBackground();Renderer.setupEventHandlers();Renderer.draw();Renderer.tick()},tick:function(){if(Renderer.queue.length>0){Renderer._rendering=true;var d=new Date();var c=Math.min(Renderer.queue.length-1,Renderer._maxThreads);for(var b=0;b<=c;b++){Renderer.queue.shift().start()}var a=new Date();setTimeout(Renderer.tick,2*(a-d))}Renderer._rendering=false},setupEventHandlers:function(){var b=function(f,g){var d={h:0,s:0,b:0,a:1};var e=toAffineTransformation(1,0,0,1,(g.pageX-Renderer.width/2)/Renderer._globalScale,(g.pageY-Renderer.height/2)/Renderer._globalScale);Renderer.drawRule(f,e,d,1);if(!Renderer._rendering){Renderer.tick()}};var c=getKeyValue("MOUSECLICK",null,Renderer.compiled);if(c){$(Renderer.canvas).click(function(d){b("MOUSECLICK",d)})}var a=getKeyValue("MOUSEMOVE",null,Renderer.compiled);if(a){$(Renderer.canvas).mousemove(function(d){b("MOUSEMOVE",d)})}},drawBackground:function(){if(Renderer.compiled.background){var b=Renderer.compiled.background;var a={h:0,s:0,b:1,a:1};var d=adjustColor(a,b);Renderer.ctx.fillStyle=colorToRgba(d);Renderer.ctx.fillRect(0,0,Renderer.width,Renderer.width)}},draw:function(){var b=Renderer.compiled.startshape;var a={h:0,s:0,b:0,a:1};Renderer.drawRule(b,IdentityTransformation(),a)},drawRule:function(h,b,c,g){if(Math.abs(b[0][1])*Renderer._globalScale<0.5&&Math.abs(b[1][1])*Renderer._globalScale<0.5){return}var j=Renderer.compiled[h];var e=0;for(var d=0;d<j.length;d++){e+=j[d].weight}var a=Math.random()*e;e=0;for(var d=0;d<=j.length-1;d++){e+=j[d].weight;if(a<=e){var f=j[d];break}}Renderer.drawShape(f,b,c,g)},_draw:function(a,c){if(Renderer.ctx.setTransform){Renderer.setTransform(a);c(Renderer.ctx);return}var e=toAffineTransformation(Renderer._globalScale,0,0,Renderer._globalScale,Renderer.width/2,Renderer.height/2);var b=compose(e,a);Renderer.ctx.save();if(Renderer.ctx.transform){Renderer.ctx.transform(b[0][0],b[1][0],b[0][1],b[1][1],b[0][2],b[1][2]);c(Renderer.ctx)}else{var d=svdTransform(b);Renderer.ctx.translate(d.dx,d.dy);Renderer.ctx.rotate(d.angle2);Renderer.ctx.scale(d.sx,d.sy);Renderer.ctx.rotate(d.angle1)}c(Renderer.ctx);Renderer.ctx.restore()},drawShape:function(e,b,c,g){for(i=0;i<e.draw.length;i++){var j=e.draw[i];var h=Renderer.adjustTransform(j,b);var d=adjustColor(c,j);switch(j.shape){case"CIRCLE":Renderer._draw(h,function(k){k.beginPath();k.fillStyle=colorToRgba(d);k.arc(0,0,0.5,0,2*Math.PI,true);k.fill();k.closePath()});break;case"SQUARE":Renderer._draw(h,function(k){k.beginPath();k.fillStyle=colorToRgba(d);k.fillRect(-0.5,-0.5,1,1);k.closePath()});break;case"TRIANGLE":Renderer._draw(h,function(k){k.beginPath();var m=0.57735;k.moveTo(0,-m);for(var l=1;l<=3;l++){k.lineTo(m*Math.sin(l*2*Math.PI/3),-m*Math.cos(l*2*Math.PI/3))}k.fillStyle=colorToRgba(d);k.fill();k.closePath()});break;default:var a=function(l,m,k){this.start=function(){Renderer.drawRule(l,m,k)}};var f=new a(j.shape,h,d);if(g==1){Renderer.queue.unshift(f)}else{Renderer.queue.push(f)}break}}},setTransform:function(a){Renderer.ctx.setTransform(Renderer._globalScale,0,0,Renderer._globalScale,Renderer.width/2,Renderer.height/2);Renderer.ctx.transform(a[0][0],a[1][0],a[0][1],a[1][1],a[0][2],a[1][2])},adjustTransform:function(k,c){var n=getKeyValue("x",0,k);var m=-getKeyValue("y",0,k);if(n!=0||m!=0){var d=toAffineTransformation(1,0,0,1,n,m);c=compose(c,d)}var a=getKeyValue(["r","rotate"],null,k);if(a!=null){var l=Math.cos(-2*Math.PI*a/360);var b=Math.sin(-2*Math.PI*a/360);var g=toAffineTransformation(l,-b,b,l,0,0);c=compose(c,g)}var o=getKeyValue(["s","size"],1,k);if(typeof(o)=="number"){o=[o,o]}if(o!=1){var e=toAffineTransformation(o[0],0,0,o[1],0,0);c=compose(c,e)}var j=getKeyValue(["f","flip"],null,k);if(j!=null){vX=Math.cos(-2*Math.PI*j/360);vY=Math.sin(-2*Math.PI*j/360);norm=1/(vX*vX+vY*vY);var h=toAffineTransformation((vX*vX-vY*vY)/norm,2*vX*vY/norm,2*vX*vY/norm,(vY*vY-vX*vX)/norm,0,0);c=compose(c,h)}return c}};function contextFree(h,f){var a=new Tokenizer();var e=a.tokenize(h);var g=new Compiler();var d=g.compile(e);var b=Renderer;Renderer.queue=[];b.render(d,f)}svdTransform=(function(){var b={};b.Matrix2D=function(j){if(j){if(typeof j=="number"){this.xx=this.yy=j}else{if(j instanceof Array){if(j.length>0){var m=b.normalize(j[0]);for(var n=1;n<j.length;++n){var k=m,o=b.normalize(j[n]);m=new b.Matrix2D();m.xx=k.xx*o.xx+k.xy*o.yx;m.xy=k.xx*o.xy+k.xy*o.yy;m.yx=k.yx*o.xx+k.yy*o.yx;m.yy=k.yx*o.xy+k.yy*o.yy;m.dx=k.xx*o.dx+k.xy*o.dy+k.dx;m.dy=k.yx*o.dx+k.yy*o.dy+k.dy}Object.extend(this,m)}}else{Object.extend(this,j)}}}};b.normalize=function(j){return(j instanceof b.Matrix2D)?j:new b.Matrix2D(j)};b.multiply=function(k){var o=b.normalize(k);for(var m=1;m<arguments.length;++m){var j=o,n=b.normalize(arguments[m]);o=new b.Matrix2D();o.xx=j.xx*n.xx+j.xy*n.yx;o.xy=j.xx*n.xy+j.xy*n.yy;o.yx=j.yx*n.xx+j.yy*n.yx;o.yy=j.yx*n.xy+j.yy*n.yy;o.dx=j.xx*n.dx+j.xy*n.dy+j.dx;o.dy=j.yx*n.dx+j.yy*n.dy+j.dy}return o};b.invert=function(j){var l=b.normalize(j),k=l.xx*l.yy-l.xy*l.yx,l=new b.Matrix2D({xx:l.yy/k,xy:-l.xy/k,yx:-l.yx/k,yy:l.xx/k,dx:(l.xy*l.dy-l.yy*l.dx)/k,dy:(l.yx*l.dx-l.xx*l.dy)/k});return l};Object.extend(b.Matrix2D,{xx:1,xy:0,yx:0,yy:1,dx:0,dy:0});var a=function(k,j){return Math.abs(k-j)<=0.000001*(Math.abs(k)+Math.abs(j))};var h=function(k,j){if(!isFinite(k)){return j}else{if(!isFinite(j)){return k}}return(k+j)/2};var c=function(j){var k=new b.Matrix2D(j);return Object.extend(k,{dx:0,dy:0,xy:k.yx,yx:k.xy})};var f=function(j){return(j.xx*j.yy<0||j.xy*j.yx>0)?-1:1};var e=function(v){var p=b.normalize(v),t=-p.xx-p.yy,r=p.xx*p.yy-p.xy*p.yx,q=Math.sqrt(t*t-4*r),m=-(t+(t<0?-q:q))/2,l=r/m,u=p.xy/(m-p.xx),o=1,s=p.xy/(l-p.xx),n=1;if(a(m,l)){u=1,o=0,s=0,n=1}if(!isFinite(u)){u=1,o=(m-p.xx)/p.xy;if(!isFinite(o)){u=(m-p.yy)/p.yx,o=1;if(!isFinite(u)){u=1,o=p.yx/(m-p.yy)}}}if(!isFinite(s)){s=1,n=(l-p.xx)/p.xy;if(!isFinite(n)){s=(l-p.yy)/p.yx,n=1;if(!isFinite(s)){s=1,n=p.yx/(l-p.yy)}}}var k=Math.sqrt(u*u+o*o),j=Math.sqrt(s*s+n*n);if(isNaN(u/=k)){u=0}if(isNaN(o/=k)){o=0}if(isNaN(s/=j)){s=0}if(isNaN(n/=j)){n=0}return{value1:m,value2:l,vector1:{x:u,y:o},vector2:{x:s,y:n}}};var g=function(o,j){var l=f(o),k=j.angle1=(Math.atan2(o.yx,o.yy)+Math.atan2(-l*o.xy,l*o.xx))/2,n=Math.cos(k),m=Math.sin(k);j.sx=h(o.xx/n,-o.xy/m);j.sy=h(o.yy/n,o.yx/m);return j};var d=function(o,j){var l=f(o),k=j.angle2=(Math.atan2(l*o.yx,l*o.xx)+Math.atan2(-o.xy,o.yy))/2,n=Math.cos(k),m=Math.sin(k);j.sx=h(o.xx/n,o.yx/m);j.sy=h(o.yy/n,-o.xy/m);return j};return function(j){var p={xx:j[0][0],xy:j[0][1],yx:j[1][0],yy:j[1][1],dx:j[0][2],dy:j[1][2]};var o=b.normalize(p),s={dx:o.dx,dy:o.dy,sx:1,sy:1,angle1:0,angle2:0};if(a(o.xy,0)&&a(o.yx,0)){return Object.extend(s,{sx:o.xx,sy:o.yy})}if(a(o.xx*o.yx,-o.xy*o.yy)){return g(o,s)}if(a(o.xx*o.xy,-o.yx*o.yy)){return d(o,s)}var n=c(o),r=e([o,n]),q=e([n,o]),k=new b.Matrix2D({xx:r.vector1.x,xy:r.vector2.x,yx:r.vector1.y,yy:r.vector2.y}),m=new b.Matrix2D({xx:q.vector1.x,xy:q.vector1.y,yx:q.vector2.x,yy:q.vector2.y}),l=new b.Matrix2D([b.invert(k),o,b.invert(m)]);g(m,s);l.xx*=s.sx;l.yy*=s.sy;d(k,s);l.xx*=s.sx;l.yy*=s.sy;return Object.extend(s,{sx:l.xx,sy:l.yy})}})();